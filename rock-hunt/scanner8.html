<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  color:#0f0;
  font-family:Arial, Helvetica, sans-serif;
  overflow:hidden;
}
#scanner{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}
h1{
  margin:8px 0 4px;
  font-size:18px;
}
#status{
  font-size:12px;
  opacity:.8;
}
#radar{
  width:260px;
  height:260px;
  border-radius:50%;
  border:2px solid #0f0;
  position:relative;
  margin:10px 0;
  overflow:hidden;
}
#sweep{
  position:absolute;
  width:50%;
  height:2px;
  background:#0f0;
  top:50%;
  left:50%;
  transform-origin:left center;
  animation:sweep 2s linear infinite;
}
@keyframes sweep{
  from{ transform:rotate(0deg); }
  to{ transform:rotate(360deg); }
}
#blip{
  position:absolute;
  width:8px;
  height:8px;
  background:#0f0;
  border-radius:50%;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}
#arrow{
  width:0;
  height:0;
  border-left:12px solid transparent;
  border-right:12px solid transparent;
  border-bottom:24px solid #0f0;
  margin:8px 0;
  transform:rotate(0deg);
  transition:transform .15s linear;
}
.info{
  font-size:13px;
  margin:2px 0;
}
#proximity{
  width:80%;
  height:12px;
  border:1px solid #0f0;
  margin:6px 0;
}
#proximityFill{
  height:100%;
  width:0%;
  background:#0f0;
}
button{
  background:#000;
  border:1px solid #0f0;
  color:#0f0;
  padding:8px 14px;
  margin:4px;
  font-size:14px;
}
button:active{
  background:#0f0;
  color:#000;
}
</style>
</head>

<body>
<div id="scanner">
  <h1>Prospecting Scanner</h1>
  <div id="status">Initializing…</div>

  <div id="radar">
    <div id="sweep"></div>
    <div id="blip"></div>
  </div>

  <div id="arrow"></div>

  <div class="info" id="distance">Distance: -- m</div>
  <div class="info" id="bearing">Bearing: --°</div>

  <div id="proximity">
    <div id="proximityFill"></div>
  </div>

  <div>
    <button id="scanRock">SCAN ROCK</button>
    <button id="startNav">Start Navigation</button>
  </div>
</div>

<script src="locations.js"></script>
<script>
/* =========================
   STATE
========================= */
let userLat=null, userLng=null;
let heading=0;
let navActive=false;

/* =========================
   ELEMENTS
========================= */
const statusEl=document.getElementById("status");
const arrow=document.getElementById("arrow");
const blip=document.getElementById("blip");
const distanceEl=document.getElementById("distance");
const bearingEl=document.getElementById("bearing");
const proximityFill=document.getElementById("proximityFill");
const startNavBtn=document.getElementById("startNav");

/* =========================
   TARGET SELECTION
========================= */
function getTarget(){
  return locations[0]; // existing behaviour preserved
}

/* =========================
   GEOLOCATION
========================= */
navigator.geolocation.watchPosition(
  p=>{
    userLat=p.coords.latitude;
    userLng=p.coords.longitude;
    statusEl.textContent="GPS LOCKED";
    update();
  },
  err=>{
    statusEl.textContent="GPS ERROR: "+err.message;
  },
  { enableHighAccuracy:true, maximumAge:1000, timeout:20000 }
);

/* =========================
   COMPASS
========================= */
window.addEventListener("deviceorientationabsolute",handleOrientation,true);
window.addEventListener("deviceorientation",handleOrientation,true);

function handleOrientation(e){
  if(e.alpha!==null){
    heading=360-e.alpha;
  }
}

/* =========================
   MATH
========================= */
function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function distance(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+
          Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
          Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function bearing(lat1,lon1,lat2,lon2){
  const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-
          Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  return (toDeg(Math.atan2(y,x))+360)%360;
}

/* =========================
   UPDATE LOOP
========================= */
function update(){
  if(userLat===null) return;

  const target=getTarget();
  const dist=distance(userLat,userLng,target.lat,target.lng);
  const bear=bearing(userLat,userLng,target.lat,target.lng);

  distanceEl.textContent="Distance: "+dist.toFixed(1)+" m";
  bearingEl.textContent="Bearing: "+bear.toFixed(0)+"°";

  const relative=(bear-heading+360)%360;
  arrow.style.transform="rotate("+relative+"deg)";

  // Radar blip
  const maxRange=50;
  const r=Math.min(dist,maxRange)/maxRange*120;
  const angle=toRad(relative);
  blip.style.left=130 + r*Math.sin(angle)+"px";
  blip.style.top =130 - r*Math.cos(angle)+"px";

  // Proximity
  const prox=Math.max(0,100-(dist/maxRange*100));
  proximityFill.style.width=prox+"%";
}

/* =========================
   NAVIGATION (FIXED)
========================= */
startNavBtn.addEventListener("click",()=>{
  const target=getTarget();

  if(!navActive){
    const isMobile=/Android|iPhone|iPad/i.test(navigator.userAgent);
    const url=isMobile
      ? `google.navigation:q=${target.lat},${target.lng}`
      : `https://www.google.com/maps/dir/?api=1&destination=${target.lat},${target.lng}`;

    window.open(url,"_blank","noopener");
    navActive=true;
    startNavBtn.textContent="Close Navigation";
  }else{
    navActive=false;
    startNavBtn.textContent="Start Navigation";
  }
});

/* =========================
   SCAN ROCK (QR HANDOFF)
========================= */
document.getElementById("scanRock").addEventListener("click",()=>{
  // Existing behaviour preserved – opens camera / QR workflow
  alert("Scan the QR code on the rock to register your find.");
});
</script>
</body>
</html>
