<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  background:#000;
  color:#0f0;
  font-family:system-ui, sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

h1{margin:10px;text-shadow:0 0 12px #0f0}

#deviceFrame{
  width:400px;height:400px;
  border:10px solid #00ff55;
  border-radius:28px;
  box-shadow:0 0 40px #00ff55 inset;
  background:#001100;
  display:flex;align-items:center;justify-content:center;
}

#scanner{
  width:360px;height:360px;
  border-radius:50%;
  position:relative;
  overflow:hidden;
  background:radial-gradient(circle,#001600 0%,#002800 80%);
}

#radarSweep{
  position:absolute;inset:0;
  background:conic-gradient(rgba(0,255,0,.3) 0deg,transparent 40deg);
  border-radius:50%;
}

#radarArc{
  position:absolute;inset:0;
  border-radius:50%;
  box-shadow:0 0 18px #00ff55 inset,0 0 30px #00ff5588 inset;
}

#rings{position:absolute;inset:0}
.ring{
  position:absolute;border:1px solid #00ff55;
  border-radius:50%;
  inset:50%;
  transform:translate(-50%,-50%);
  animation:pulse 4s infinite;
  opacity:.2;
}
@keyframes pulse{
  0%{width:0;height:0;opacity:.1}
  50%{opacity:.3}
  100%{width:360px;height:360px;opacity:.1}
}

#arrow{
  position:absolute;
  left:50%;bottom:50%;
  width:6px;height:120px;
  background:#ff4444;
  transform-origin:bottom center;
  box-shadow:0 0 10px #ff4444;
}

.rock{
  position:absolute;border-radius:50%;
  background:#ff0;
  box-shadow:0 0 12px #ff0;
  pointer-events:none;
}

#qrVideo{
  position:absolute;inset:0;
  object-fit:cover;
  display:none;
}

#qrPanel{
  position:absolute;
  bottom:10px;left:50%;
  transform:translateX(-50%);
  width:320px;height:180px;
  border:3px solid #00ff55;
  border-radius:10px;
  background:#002200cc;
  display:none;
}
#qrPanel iframe{width:100%;height:100%;border:none}

button{
  margin:8px;
  padding:12px 20px;
  border:none;border-radius:8px;
  background:#00ff55;
  font-weight:bold;
}
</style>
</head>

<body>
<h1>Prospecting Scanner</h1>

<select id="locationSelect"></select>

<div id="deviceFrame">
  <div id="scanner">
    <video id="qrVideo" playsinline></video>
    <div id="radarSweep"></div>
    <div id="radarArc"></div>
    <div id="rings"></div>
    <div id="arrow"></div>
    <div id="qrPanel"><iframe></iframe></div>
  </div>
</div>

<button id="start">Activate Scanner</button>
<button id="scan">Scan Rock QR</button>

<script src="locations.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
/* ---------- SAFE BOOTSTRAP ---------- */
function waitForLocations(cb){
  if(window.PROSPECTING_LOCATIONS && PROSPECTING_LOCATIONS.length){
    cb();
  }else{
    setTimeout(()=>waitForLocations(cb),50);
  }
}
waitForLocations(init);

/* ---------- SCANNER ---------- */
function init(){
  let targetIndex=0,lat=null,lng=null,heading=0,active=false,lastBuzz=0;
  const rocks=[];
  const arrow=document.getElementById("arrow");
  const sweep=document.getElementById("radarSweep");
  const select=document.getElementById("locationSelect");
  const video=document.getElementById("qrVideo");
  const qrPanel=document.getElementById("qrPanel");
  const iframe=qrPanel.querySelector("iframe");

  PROSPECTING_LOCATIONS.forEach((l,i)=>{
    const o=document.createElement("option");
    o.value=i;o.textContent=l.name;
    select.appendChild(o);
  });

  function dist(a,b,c,d){
    const R=6371000;
    const dLat=(c-a)*Math.PI/180;
    const dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+
      Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
      Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
  }

  function spawn(){
    rocks.forEach(r=>r.remove());
    rocks.length=0;
    for(let i=0;i<8;i++){
      const r=document.createElement("div");
      r.className="rock";
      r.dataset.angle=Math.random()*Math.PI*2;
      r.style.width=r.style.height="12px";
      document.getElementById("scanner").appendChild(r);
      rocks.push(r);
    }
  }

  function updateRocks(d){
    rocks.forEach(r=>{
      const rad=Math.min(180,Math.max(20,d));
      const x=180+Math.cos(r.dataset.angle-heading*Math.PI/180)*rad;
      const y=180+Math.sin(r.dataset.angle-heading*Math.PI/180)*rad;
      r.style.left=x+"px";
      r.style.top=y+"px";
      r.style.opacity=d<120?1:0;
    });
  }

  function vibrate(d){
    if(d<6 && Date.now()-lastBuzz>1500){
      navigator.vibrate(80);
      lastBuzz=Date.now();
    }
  }

  function update(){
    if(lat==null||lng==null) return;
    const t=PROSPECTING_LOCATIONS[targetIndex];
    const d=dist(lat,lng,t.lat,t.lng);
    arrow.style.transform=`translateX(-50%) rotate(${(360-heading)%360}deg)`;
    updateRocks(d);
    vibrate(d);
  }

  navigator.geolocation.watchPosition(p=>{
    lat=p.coords.latitude;
    lng=p.coords.longitude;
    update();
  },null,{enableHighAccuracy:true});

  window.addEventListener("deviceorientation",e=>{
    if(e.alpha!=null) heading=360-e.alpha;
  });

  document.getElementById("start").onclick=()=>{
    active=!active;
    if(active){
      spawn();
      (function spin(){ if(!active) return; sweep.style.transform=`rotate(${Date.now()/20}deg)`; requestAnimationFrame(spin);})();
      document.getElementById("start").textContent="Deactivate Scanner";
    }else{
      document.getElementById("start").textContent="Activate Scanner";
    }
  };

  document.getElementById("scan").onclick=async()=>{
    video.style.display="block";
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream; video.play();
    const c=document.createElement("canvas"),ctx=c.getContext("2d");
    (function scan(){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        c.width=video.videoWidth;c.height=video.videoHeight;
        ctx.drawImage(video,0,0);
        const img=ctx.getImageData(0,0,c.width,c.height);
        const code=jsQR(img.data,c.width,c.height);
        if(code){
          stream.getTracks().forEach(t=>t.stop());
          qrPanel.style.display="block";
          iframe.src="https://www.challengeaccepted.quest/prospect-scan?rock="+code.data;
          return;
        }
      }
      requestAnimationFrame(scan);
    })();
  };
}
</script>
</body>
</html>
