<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
/* --- Body & Fonts --- */
body { margin:0; background:#000; color:#0f0; font-family:monospace; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:10px;}
h1 { margin:10px 0; text-align:center; text-shadow:0 0 10px #0f0,0 0 20px #0f0555; }
/* --- Device Frame --- */
#deviceFrame {
  width:400px; height:500px; border:10px solid #00ff44; border-radius:30px;
  box-shadow:0 0 50px #00ff44 inset, 0 0 30px #00ff22; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  background:#001100; position:relative; padding:20px; overflow:hidden;
}
/* --- Scanner Container --- */
#scanner-container {
  width:360px; height:360px; border-radius:50%; position:relative; overflow:hidden;
  background:radial-gradient(circle at center, #001100 0%, #002200 80%);
  box-shadow: inset 0 0 30px #00ff0044, 0 0 40px #00ff0088; border:3px solid #00ff00;
}
/* --- Radar Elements --- */
#radarSweep {
  position:absolute; width:100%; height:100%; border-radius:50%;
  background:conic-gradient(rgba(0,255,0,0.3) 0deg, rgba(0,255,0,0) 60deg);
  transform:rotate(0deg); pointer-events:none;
}
#radarRings {
  position:absolute; width:100%; height:100%; border-radius:50%; pointer-events:none;
  box-shadow:0 0 0 1px #0f0 inset, 0 0 0 2px #0f0555 inset, 0 0 0 3px #0f0 inset;
}
#arrow {
  position:absolute; width:10px; height:40px; background:#0f0; top:50%; left:50%;
  transform-origin:50% 100%; transform:rotate(0deg) translate(-50%,-100%);
  border-radius:2px;
}
.rock {
  position:absolute; width:6px; height:6px; border-radius:50%;
  opacity:0; transform:translate(0,0) scale(0); pointer-events:none;
  transition: transform 0.1s linear, opacity 0.3s linear;
}
/* --- QR Video & Overlay --- */
#qrVideo { position:absolute; width:100%; height:100%; top:0; left:0; object-fit:cover; display:none; }
#qrOverlay {
  position:absolute; width:100%; height:100%; top:0; left:0;
  display:flex; align-items:center; justify-content:center; color:#0f0;
  font-size:18px; text-align:center; text-shadow:0 0 10px #0f0,0 0 20px #0f0555;
  pointer-events:none;
}
/* --- Pulse/Heartbeat --- */
#overlayPulse {
  position:absolute; width:100%; height:100%; border-radius:50%;
  background:radial-gradient(circle, rgba(0,255,0,0.2) 0%, transparent 70%);
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%{ transform:scale(0.8); opacity:0.4; }
  50%{ transform:scale(1); opacity:0.2; }
  100%{ transform:scale(0.8); opacity:0.4; }
}
/* --- Info Boxes --- */
#info { margin-top:10px; width:400px; display:flex; flex-wrap:wrap; justify-content:space-between; }
.box { width:48%; margin-bottom:5px; background:#002200; padding:5px; border-radius:5px; border:1px solid #0f0; text-align:center; font-size:14px; }
/* --- Proximity Meter --- */
#proximityMeter { width:360px; height:10px; border:1px solid #0f0; margin-top:10px; border-radius:5px; overflow:hidden; }
#proximityFill { width:0%; height:100%; background:#0f0; transition:width 0.3s; }
/* --- Buttons --- */
button { margin:5px; padding:10px 15px; border:none; border-radius:5px; background:#0f0; color:#000; font-weight:bold; cursor:pointer; }
button:disabled { opacity:0.5; cursor:default; }
</style>
</head>
<body>
<h1>Futuristic Prospecting Scanner</h1>

<select id="locationSelect"><option>Loading locations...</option></select>

<div id="deviceFrame">
  <div id="scanner-container">
    <video id="qrVideo" autoplay playsinline></video>
    <div id="overlayPulse"></div>
    <div id="radarSweep"></div>
    <div id="radarRings"></div>
    <div id="arrow"></div>
    <div id="qrOverlay">PLACE ROCK CODE HERE</div>
  </div>
</div>

<div id="info">
  <div class="box" id="gps">GPS: —</div>
  <div class="box" id="target">Target: —</div>
  <div class="box" id="distance">Distance: —</div>
  <div class="box" id="bearing">Bearing: —</div>
  <div class="box" id="compass">Compass: —</div>
  <div class="box" id="accuracy">Accuracy: —</div>
  <div class="box" id="hotcold">Proximity: —</div>
</div>

<div id="proximityMeter"><div id="proximityFill"></div></div>

<button id="start">Activate Scanner</button>
<button id="scanRock">Start QR Scanner</button>
<button id="toggleCamera">Toggle Camera</button>

<script src="locations.js?v=21"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
// --- Globals ---
let TARGET_INDEX = 0, rocks = [], watchId, compassHeading = 0, qrActive = false, cameraStream = null;

// --- DOM References ---
const select = document.getElementById("locationSelect");
const startBtn = document.getElementById("start");
const scanBtn = document.getElementById("scanRock");
const toggleCamBtn = document.getElementById("toggleCamera");
const gpsBox = document.getElementById("gps");
const targetBox = document.getElementById("target");
const distanceBox = document.getElementById("distance");
const bearingBox = document.getElementById("bearing");
const compassBox = document.getElementById("compass");
const accuracyBox = document.getElementById("accuracy");
const hotcoldBox = document.getElementById("hotcold");
const proximityFill = document.getElementById("proximityFill");
const radarSweep = document.getElementById("radarSweep");
const arrow = document.getElementById("arrow");
const qrVideo = document.getElementById("qrVideo");
const qrOverlay = document.getElementById("qrOverlay");

// --- Initialization ---
function initScanner() {
  if(typeof PROSPECTING_LOCATIONS==="undefined"){setTimeout(initScanner,50);return;}
  if(PROSPECTING_LOCATIONS.length===0){alert("No locations defined!"); return;}

  // Populate dropdown
  select.innerHTML="";
  PROSPECTING_LOCATIONS.forEach((loc,i)=>{
    const opt = document.createElement('option'); opt.value=i; opt.textContent=loc.name;
    select.appendChild(opt);
  });
  select.value = TARGET_INDEX;

  select.addEventListener('change',()=>{
    TARGET_INDEX = parseInt(select.value);
    spawnRocks();
    updateDisplay();
  });

  spawnRocks();
  startGPS();
  animateRadar();
}

// --- Rocks ---
function spawnRocks() {
  rocks=[];
  const target = PROSPECTING_LOCATIONS[TARGET_INDEX];
  const container = document.getElementById("scanner-container");
  container.querySelectorAll('.rock').forEach(r=>r.remove());

  for(let i=0;i<5;i++){
    const offsetLat=(Math.random()-0.5)*0.000054;
    const offsetLng=(Math.random()-0.5)*0.000054;
    const el = document.createElement('div'); el.className='rock';
    container.appendChild(el);
    rocks.push({lat:target.lat+offsetLat,lng:target.lng+offsetLng,el});
  }
}

// --- GPS & Radar Updates ---
function startGPS(){
  if(!navigator.geolocation){alert("Geolocation not supported"); return;}
  watchId = navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    const target = PROSPECTING_LOCATIONS[TARGET_INDEX];
    gpsBox.textContent=`GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    targetBox.textContent=`Target: ${target.lat.toFixed(6)}, ${target.lng.toFixed(6)}`;
    const d = distance(lat,lng,target.lat,target.lng);
    const br = bearing(lat,lng,target.lat,target.lng);
    distanceBox.textContent=`Distance: ${d.toFixed(1)} m`;
    bearingBox.textContent=`Bearing: ${br.toFixed(0)}°`;
    accuracyBox.textContent=`Accuracy: ${pos.coords.accuracy} m`;
    compassBox.textContent=`Compass: ${compassHeading.toFixed(0)}°`;
    hotcoldBox.textContent = d<target.radius ? "HOT" : "COLD";
    proximityFill.style.width = `${Math.min(100,(d/target.radius*100))}%`;

    rocks.forEach(r=>{
      const dx=(r.lng-lng)*85000;
      const dy=(r.lat-lat)*111000;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist<20){
        const s = 0.3 + 0.3*(20-dist)/20;
        r.el.style.opacity = 1; r.el.style.transform=`translate(${dx*2}px,${-dy*2}px) scale(${s})`;
        if(dist<5){navigator.vibrate([100,50,100]);}
      } else { r.el.style.opacity=0; r.el.style.transform=`scale(0)`; }
    });
  }, err=>{console.error(err);},{enableHighAccuracy:true, maximumAge:1000});
}

function distance(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function bearing(lat1,lon1,lat2,lon2){
  const y=Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180);
  const x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

// --- Radar Sweep ---
function animateRadar(){
  let angle=0;
  setInterval(()=>{
    angle=(angle+2)%360;
    radarSweep.style.transform=`rotate(${angle}deg)`;
    arrow.style.transform=`rotate(${compassHeading}deg) translate(-50%,-100%)`;
  },50);
}

// --- Compass ---
window.addEventListener("deviceorientationabsolute",e=>{
  if(e.alpha!=null){ compassHeading = e.alpha; }
});

// --- QR Scanner ---
scanBtn.addEventListener('click', startQR);
toggleCamBtn.addEventListener('click', toggleCamera);

function startQR(){
  if(qrActive){return;}
  qrActive=true; qrVideo.style.display='block';
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{
    cameraStream=stream;
    qrVideo.srcObject=stream;
    scanFrame();
  }).catch(err=>{console.error(err);});
}

function toggleCamera(){
  if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; qrVideo.style.display='none'; qrActive=false;}
  else startQR();
}

function scanFrame(){
  if(!qrActive) return;
  const canvas=document.createElement('canvas');
  canvas.width=qrVideo.videoWidth; canvas.height=qrVideo.videoHeight;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(qrVideo,0,0);
  const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const code=jsQR(imageData.data,canvas.width,canvas.height);
  if(code){ window.open(`https://www.challengeaccepted.quest/prospect-scan?rock=${code.data}`,'_blank'); qrActive=false; toggleCamera();}
  else requestAnimationFrame(scanFrame);
}

// --- Misc ---
function updateDisplay(){ /* extra UI refresh if needed */ }
startBtn.addEventListener('click',()=>{alert('Scanner activated!');});

initScanner();
</script>
</body>
</html>
