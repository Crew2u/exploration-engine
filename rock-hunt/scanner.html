<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body {
  margin:0;
  font-family:system-ui,sans-serif;
  background:#000;
  color:#0f0;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:10px;
}

h1 {
  margin:10px 0;
  text-align:center;
  text-shadow:0 0 10px #0f0,0 0 20px #0f0555;
}

#deviceFrame {
  width:400px;
  height:400px;
  border:10px solid #00ff44;
  border-radius:30px;
  box-shadow:0 0 50px #00ff44 inset;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  background:#001100;
}

#scanner-container {
  width:360px;
  height:360px;
  border-radius:50%;
  position:relative;
  overflow:hidden;
  background:radial-gradient(circle at center, #001100 0%, #002200 80%);
  box-shadow: inset 0 0 30px #00ff0044, 0 0 40px #00ff0088;
  border:3px solid #00ff00;
}

/* Radar */
#radarSweep {
  position:absolute;
  inset:0;
  border-radius:50%;
  background:conic-gradient(rgba(0,255,0,0.25) 0deg, rgba(0,255,0,0) 30deg);
  z-index:2;
  filter:blur(1px);
}

#radarArc {
  position:absolute;
  inset:0;
  border-radius:50%;
  box-shadow:0 0 20px #00ff44 inset, 0 0 30px #00ff4488 inset;
  z-index:3;
}

#overlayPulse {
  position:absolute;
  inset:0;
  border-radius:50%;
  box-shadow:0 0 40px #00ff44 inset, 0 0 60px #00ff4488 inset;
  animation:pulse 2s infinite alternate;
  z-index:1;
}

@keyframes pulse {
  from { transform:scale(0.97); opacity:0.7; }
  to   { transform:scale(1); opacity:1; }
}

/* Compass arrow */
#arrow {
  position:absolute;
  bottom:50%;
  left:50%;
  width:4px;
  height:120px;
  background:#ff4444;
  transform-origin:bottom center;
  border-radius:4px;
  z-index:5;
  box-shadow:0 0 8px #ff4444,0 0 20px #ff4444aa;
}

/* Rocks */
.rock {
  position:absolute;
  width:4px;
  height:4px;
  border-radius:50%;
  background:#ffcc00;
  box-shadow:0 0 6px #ffcc00,0 0 12px #ffcc0055;
  opacity:0;
  transition:
    transform 0.15s linear,
    opacity 0.4s ease,
    width 0.3s ease,
    height 0.3s ease;
  z-index:7;
}

/* QR Scanner overlay */
#qrOverlay {
  position:absolute;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.75);
  z-index:20;
}

#qrOverlay video {
  width:100%;
  height:100%;
  object-fit:cover;
}

#qrReticle {
  position:absolute;
  top:50%;
  left:50%;
  width:200px;
  height:200px;
  transform:translate(-50%,-50%);
  border:2px solid #00ff44;
  box-shadow:0 0 20px #00ff44;
}

#qrText {
  position:absolute;
  bottom:20px;
  width:100%;
  text-align:center;
  color:#00ff44;
  font-weight:bold;
  text-shadow:0 0 10px #00ff44;
}

/* Info */
#info {
  width:90%;
  max-width:360px;
  margin-top:10px;
}

.box {
  border:1px solid #00ff0044;
  background:#001100aa;
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  text-align:center;
}

button, select {
  margin:10px 0;
  padding:12px 22px;
  border-radius:8px;
  border:none;
  background:#00ff00;
  color:#000;
  font-size:1em;
}

#scanRock {
  background:#ff4444;
  color:#fff;
  font-weight:bold;
  width:90%;
  max-width:360px;
  box-shadow:0 0 8px #ff4444;
}

#proximityMeter {
  width:90%;
  max-width:360px;
  height:18px;
  border-radius:10px;
  overflow:hidden;
  border:1px solid #00ff44;
  background:#003322;
}

#proximityFill {
  height:100%;
  width:0%;
  background:#ff4444;
  transition:width 0.3s ease;
}
</style>
</head>

<body>

<h1>Futuristic Prospecting Scanner</h1>

<select id="locationSelect">
  <option>Loading locations…</option>
</select>

<div id="deviceFrame">
  <div id="scanner-container">
    <div id="overlayPulse"></div>
    <div id="radarSweep"></div>
    <div id="radarArc"></div>
    <div id="arrow"></div>

    <!-- QR Scanner -->
    <div id="qrOverlay">
      <video id="qrVideo" playsinline></video>
      <div id="qrReticle"></div>
      <div id="qrText">PLACE ROCK CODE HERE</div>
    </div>
  </div>
</div>

<div id="info">
  <div class="box" id="gps">GPS: —</div>
  <div class="box" id="target">Target: —</div>
  <div class="box" id="distance">Distance: —</div>
  <div class="box" id="compass">Compass: —</div>
  <div class="box" id="accuracy">Accuracy: —</div>
</div>

<div id="proximityMeter">
  <div id="proximityFill"></div>
</div>

<button id="scanRock">SCAN ROCK</button>
<button id="toggleCam">TURN CAMERA OFF</button>

<script src="locations.js"></script>

<script>
/* ===================== STATE ===================== */
let currentLat=null, currentLon=null, heading=0;
let rocks=[];
let targetIndex=0;
let scanning=false;
let videoStream=null;

const MAX_VIS=20;
const RADAR_R=160;

/* ===================== DOM ===================== */
const scanner=document.getElementById("scanner-container");
const sweep=document.getElementById("radarSweep");
const arrow=document.getElementById("arrow");
const select=document.getElementById("locationSelect");
const fill=document.getElementById("proximityFill");

const qrOverlay=document.getElementById("qrOverlay");
const qrVideo=document.getElementById("qrVideo");

/* ===================== LOCATIONS LOADER (FIXED) ===================== */
function waitForLocations(){
  if(!window.PROSPECTING_LOCATIONS || !Array.isArray(PROSPECTING_LOCATIONS)){
    return setTimeout(waitForLocations,50);
  }
  initLocations();
}

function initLocations(){
  select.innerHTML="";
  PROSPECTING_LOCATIONS.forEach((l,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=l.name;
    select.appendChild(o);
  });
  select.onchange=()=>{
    targetIndex=parseInt(select.value);
    spawnRocks();
  };
  spawnRocks();
}

/* ===================== ROCKS ===================== */
function spawnRocks(){
  rocks.forEach(r=>r.el.remove());
  rocks=[];
  const t=PROSPECTING_LOCATIONS[targetIndex];

  for(let i=0;i<6;i++){
    const el=document.createElement("div");
    el.className="rock";
    scanner.appendChild(el);
    rocks.push({
      el,
      lat:t.lat+(Math.random()-0.5)*0.00003,
      lng:t.lng+(Math.random()-0.5)*0.00003
    });
  }
}

function hav(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function updateRocks(){
  if(currentLat===null) return;
  rocks.forEach(r=>{
    const d=hav(currentLat,currentLon,r.lat,r.lng);
    if(d>MAX_VIS){
      r.el.style.opacity=0;
      return;
    }
    const scale=(MAX_VIS-d)/MAX_VIS;
    const dx=(r.lng-currentLon)*90000;
    const dy=(r.lat-currentLat)*111000;
    const x=180+dx/MAX_VIS*RADAR_R;
    const y=180-dy/MAX_VIS*RADAR_R;
    r.el.style.transform=`translate(${x}px,${y}px)`;
    r.el.style.width=r.el.style.height=(4+scale*8)+"px";
    r.el.style.opacity=scale;
  });
}

/* ===================== GPS ===================== */
navigator.geolocation.watchPosition(p=>{
  currentLat=p.coords.latitude;
  currentLon=p.coords.longitude;
  document.getElementById("gps").textContent=`You: ${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
  document.getElementById("accuracy").textContent=`Accuracy ±${p.coords.accuracy.toFixed(1)}m`;

  const t=PROSPECTING_LOCATIONS[targetIndex];
  const d=hav(currentLat,currentLon,t.lat,t.lng);
  document.getElementById("target").textContent=`Target: ${t.name}`;
  document.getElementById("distance").textContent=`Distance: ${d.toFixed(1)}m`;
  fill.style.width=Math.min(100,(1-d/50)*100)+"%";

  if(d<5 && navigator.vibrate && Math.random()<0.3) navigator.vibrate(100);
},{enableHighAccuracy:true});

/* ===================== COMPASS ===================== */
window.addEventListener("deviceorientation",e=>{
  if(e.alpha!=null){
    heading=360-e.alpha;
    arrow.style.transform=`translateX(-50%) rotate(${heading}deg)`;
    document.getElementById("compass").textContent=`Compass: ${heading.toFixed(0)}°`;
  }
});

/* ===================== QR SCANNER ===================== */
const detector = ("BarcodeDetector" in window)
  ? new BarcodeDetector({formats:["qr_code"]})
  : null;

async function startScan(){
  if(!detector) return alert("QR not supported on this device");
  videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  qrVideo.srcObject=videoStream;
  await qrVideo.play();
  qrOverlay.style.display="block";
  scanning=true;
  scanLoop();
}

function stopScan(){
  scanning=false;
  qrOverlay.style.display="none";
  if(videoStream){
    videoStream.getTracks().forEach(t=>t.stop());
    videoStream=null;
  }
}

async function scanLoop(){
  if(!scanning) return;
  const codes=await detector.detect(qrVideo);
  if(codes.length){
    alert("ROCK FOUND:\n"+codes[0].rawValue);
    stopScan();
  }
  requestAnimationFrame(scanLoop);
}

document.getElementById("scanRock").onclick=startScan;
document.getElementById("toggleCam").onclick=stopScan;

/* ===================== LOOP ===================== */
function animate(){
  sweep.style.transform=`rotate(${Date.now()/20%360}deg)`;
  updateRocks();
  requestAnimationFrame(animate);
}

waitForLocations();
animate();
</script>

</body>
</html>
