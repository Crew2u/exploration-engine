<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  background:#000;
  color:#0f0;
  font-family:system-ui,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

h1{margin:8px;text-shadow:0 0 10px #0f0}

#deviceFrame{
  width:400px;height:400px;
  border:10px solid #00ff55;
  border-radius:26px;
  box-shadow:0 0 40px #00ff55 inset;
  background:#001100;
  position:relative;
}

#scanner,#mapView{
  position:absolute;
  inset:10px;
  border-radius:50%;
  overflow:hidden;
}

#scanner{
  background:radial-gradient(circle,#001600 0%,#002800 80%);
}

#mapView{
  display:none;
  border-radius:16px;
}

#mapView iframe{
  width:100%;
  height:100%;
  border:none;
}

/* Radar */
#radarSweep{
  position:absolute;inset:0;
  background:conic-gradient(rgba(0,255,0,.3),transparent 50deg);
  border-radius:50%;
  pointer-events:none;
}

#radarArc{
  position:absolute;inset:0;
  border-radius:50%;
  box-shadow:0 0 18px #00ff55 inset,0 0 30px #00ff5588 inset;
  pointer-events:none;
}

#rings{position:absolute;inset:0;pointer-events:none}
.ring{
  position:absolute;
  border:1px solid #00ff55;
  border-radius:50%;
  inset:50%;
  transform:translate(-50%,-50%);
  animation:pulse 4s infinite;
  opacity:.2;
}
@keyframes pulse{
  0%{width:0;height:0}
  100%{width:360px;height:360px}
}

#arrow{
  position:absolute;
  left:50%;bottom:50%;
  width:6px;height:120px;
  background:#ff4444;
  transform-origin:bottom center;
  box-shadow:0 0 10px #ff4444;
  z-index:6;
}

/* Rocks */
.rock{
  position:absolute;
  width:6px;height:6px;
  border-radius:50%;
  background:#ff0;
  box-shadow:0 0 6px #ff0;
  opacity:.8;
  z-index:2; /* behind UI */
}

/* QR */
#qrVideo{display:none;position:absolute;inset:0;object-fit:cover}
#qrPanel{
  position:absolute;
  bottom:8px;left:50%;
  transform:translateX(-50%);
  width:320px;height:180px;
  background:#002200cc;
  border:2px solid #00ff55;
  border-radius:10px;
  display:none;
  z-index:10;
}
#qrPanel iframe{width:100%;height:100%;border:none}

button{
  margin:8px;
  padding:12px 20px;
  border:none;border-radius:8px;
  background:#00ff55;
  font-weight:bold;
}
</style>
</head>

<body>
<h1>Prospecting Scanner</h1>

<select id="locationSelect"></select>

<div id="deviceFrame">
  <div id="scanner">
    <video id="qrVideo" playsinline></video>
    <div id="radarSweep"></div>
    <div id="radarArc"></div>
    <div id="rings"></div>
    <div id="arrow"></div>
    <div id="qrPanel"><iframe></iframe></div>
  </div>
  <div id="mapView"><iframe></iframe></div>
</div>

<button id="toggleScanner">Activate Scanner</button>
<button id="scanQR">Scan Rock QR</button>

<script src="locations.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
function waitForLocations(cb){
  if(window.PROSPECTING_LOCATIONS) cb();
  else setTimeout(()=>waitForLocations(cb),50);
}
waitForLocations(init);

function init(){
  let active=false,lat=null,lng=null,heading=0,lastBuzz=0;
  let targetIndex=0,rocks=[];
  const scanner=document.getElementById("scanner");
  const mapView=document.getElementById("mapView");
  const mapFrame=mapView.querySelector("iframe");
  const arrow=document.getElementById("arrow");
  const sweep=document.getElementById("radarSweep");

  const select=document.getElementById("locationSelect");
  PROSPECTING_LOCATIONS.forEach((l,i)=>{
    const o=document.createElement("option");
    o.value=i;o.textContent=l.name;
    select.appendChild(o);
  });
  select.onchange=()=>targetIndex=select.value;

  function dist(a,b,c,d){
    const R=6371000;
    const dLat=(c-a)*Math.PI/180;
    const dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+
      Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
      Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
  }

  function spawnRocks(){
    rocks.forEach(r=>r.remove());
    rocks=[];
    for(let i=0;i<8;i++){
      const r=document.createElement("div");
      r.className="rock";
      r.dataset.angle=Math.random()*Math.PI*2;
      scanner.appendChild(r);
      rocks.push(r);
    }
  }

  function updateRocks(distance){
    rocks.forEach(r=>{
      const rad=Math.min(170,Math.max(20,distance));
      const x=180+Math.cos(r.dataset.angle-heading*Math.PI/180)*rad;
      const y=180+Math.sin(r.dataset.angle-heading*Math.PI/180)*rad;
      r.style.left=x+"px";
      r.style.top=y+"px";
      r.style.opacity=distance<150?1:0.6;
    });
  }

  function vibrate(distance){
    if(distance<6 && Date.now()-lastBuzz>2000){
      navigator.vibrate(80);
      lastBuzz=Date.now();
    }
  }

  function update(){
    if(!active||lat==null) return;
    const t=PROSPECTING_LOCATIONS[targetIndex];
    const distance=dist(lat,lng,t.lat,t.lng);

    // Map switch
    if(distance>100){
      scanner.style.display="none";
      mapView.style.display="block";
      mapFrame.src=`https://www.google.com/maps?q=${t.lat},${t.lng}&output=embed`;
    }else{
      scanner.style.display="block";
      mapView.style.display="none";
    }

    arrow.style.transform=`translateX(-50%) rotate(${360-heading}deg)`;
    updateRocks(distance);
    vibrate(distance);

    // HUD display
    if(!document.getElementById('hud')){
      const hud=document.createElement('div');
      hud.id='hud';
      hud.style.position='absolute';
      hud.style.top='10px';
      hud.style.left='10px';
      hud.style.color='#0f0';
      hud.style.zIndex=10;
      hud.style.fontSize='12px';
      scanner.appendChild(hud);
    }
    document.getElementById('hud').innerHTML=
      `Target: ${t.name}<br>Distance: ${distance.toFixed(1)} m`;
  }

  navigator.geolocation.watchPosition(p=>{
    lat=p.coords.latitude;
    lng=p.coords.longitude;
    update();
  },null,{enableHighAccuracy:true});

  window.addEventListener("deviceorientation",e=>{
    if(e.alpha!=null) heading=360-e.alpha;
  });

  document.getElementById("toggleScanner").onclick=()=>{
    active=!active;
    document.getElementById("toggleScanner").textContent=
      active?"Deactivate Scanner":"Activate Scanner";
    if(active){
      spawnRocks();
      (function spin(){
        if(!active) return;
        sweep.style.transform=`rotate(${Date.now()/20}deg)`;
        requestAnimationFrame(spin);
      })();
    }
  };

  document.getElementById("scanQR").onclick=async()=>{
    const video=document.getElementById("qrVideo");
    const panel=document.getElementById("qrPanel");
    const frame=panel.querySelector("iframe");
    video.style.display="block";
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;video.play();
    const c=document.createElement("canvas"),ctx=c.getContext("2d");
    (function scan(){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        c.width=video.videoWidth;c.height=video.videoHeight;
        ctx.drawImage(video,0,0);
        const img=ctx.getImageData(0,0,c.width,c.height);
        const code=jsQR(img.data,c.width,c.height);
        if(code){
          stream.getTracks().forEach(t=>t.stop());
          panel.style.display="block";
          frame.src=`https://www.challengeaccepted.quest/prospect-scan?rock=${code.data}`;
          return;
        }
      }
      requestAnimationFrame(scan);
    })();
  };
}
</script>
</body>
</html>
