<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- STYLES â€” UNCHANGED -->
<style>
/* [ styles exactly as you provided â€” unchanged ] */
body { 
  margin:0; font-family:system-ui,sans-serif; background:#000; color:#0f0;
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:10px;
}
h1 { margin:10px 0; text-align:center; text-shadow:0 0 10px #0f0,0 0 20px #0f0555; }
#deviceFrame { width:400px; height:400px; border:10px solid #00ff44; border-radius:30px;
  box-shadow:0 0 50px #00ff44 inset; position:relative; background:#001100; }
#scanner-container { width:360px; height:360px; border-radius:50%; position:relative; overflow:hidden;
  background:radial-gradient(circle,#001100 0%,#002200 80%); border:3px solid #00ff00; }
#radarSweep { position:absolute; inset:0; border-radius:50%;
  background:conic-gradient(rgba(0,255,0,.25), transparent 25deg); z-index:2; }
#radarArc { position:absolute; inset:0; border-radius:50%;
  box-shadow:0 0 20px #00ff44 inset,0 0 30px #00ff4488 inset; z-index:3; }
#radarRings { position:absolute; inset:0; z-index:1; }
.ring { position:absolute; border:1px solid #00ff22; border-radius:50%;
  top:50%; left:50%; transform:translate(-50%,-50%) scale(0); opacity:.2;
  animation:ringPulse 4s infinite; }
@keyframes ringPulse {
  0%{transform:translate(-50%,-50%) scale(0);opacity:.1}
  50%{transform:translate(-50%,-50%) scale(1);opacity:.3}
  100%{transform:translate(-50%,-50%) scale(0);opacity:.1}
}
#arrow { position:absolute; bottom:50%; left:50%; width:6px; height:120px;
  background:#ff4444; transform-origin:bottom center; z-index:5; }
.rock { position:absolute; width:20px; height:20px; border-radius:50%;
  box-shadow:0 0 8px #ff0; z-index:4; }
#qrVideo { display:none; position:absolute; inset:0; object-fit:cover; border-radius:50%; }
#qrPanel { position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  width:320px; height:180px; display:none; border:3px solid #00ff44;
  background:#002200bb; border-radius:12px; z-index:10; }
#qrPanel iframe { width:100%; height:100%; border:none; }
button, select { margin:10px 0; padding:12px 22px; border-radius:8px;
  border:none; background:#00ff00; font-size:1em; }
</style>
</head>

<body>
<h1>Futuristic Prospecting Scanner</h1>

<select id="locationSelect">
  <option>Loading locationsâ€¦</option>
</select>

<div id="deviceFrame">
  <div id="scanner-container">
    <video id="qrVideo" playsinline></video>
    <div id="radarSweep"></div>
    <div id="radarArc"></div>
    <div id="radarRings"></div>
    <div id="arrow"></div>
    <div id="qrPanel"><iframe></iframe></div>
  </div>
</div>

<button id="start">Activate Scanner</button>
<button id="scanRock">Start QR Scanner</button>

<script src="locations.js?v=12"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
/* ðŸ”§ FIX: WAIT FOR LOCATIONS TO LOAD */
(function waitForLocations(){
  if(Array.isArray(window.PROSPECTING_LOCATIONS) && PROSPECTING_LOCATIONS.length){
    initScanner();
  } else {
    setTimeout(waitForLocations, 50);
  }
})();

function initScanner(){

  let TARGET_INDEX = 0;
  let lat=null, lon=null, heading=null;
  let scannerActive=false, sweepAngle=0;
  let rocks=[];

  const select=document.getElementById("locationSelect");
  const arrow=document.getElementById("arrow");
  const radarSweep=document.getElementById("radarSweep");
  const rings=document.getElementById("radarRings");

  /* Populate locations */
  select.innerHTML="";
  PROSPECTING_LOCATIONS.forEach((l,i)=>{
    const o=document.createElement("option");
    o.value=i; o.textContent=l.name;
    select.appendChild(o);
  });

  select.onchange=()=>TARGET_INDEX=parseInt(select.value);

  function haversine(a,b,c,d){
    const R=6371000;
    const dLat=(c-a)*Math.PI/180;
    const dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+
      Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
      Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
  }

  function bearing(a,b,c,d){
    const y=Math.sin((d-b)*Math.PI/180)*Math.cos(c*Math.PI/180);
    const x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-
      Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos((d-b)*Math.PI/180);
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
  }

  function spawnRocks(){
    rocks.forEach(r=>r.remove());
    rocks=[];
    for(let i=0;i<8;i++){
      const r=document.createElement("div");
      r.className="rock";
      r.dataset.angle=Math.random()*Math.PI*2;
      document.getElementById("scanner-container").appendChild(r);
      rocks.push(r);
    }
  }

  function update(){
    if(!scannerActive||lat==null||heading==null) return;
    const t=PROSPECTING_LOCATIONS[TARGET_INDEX];
    const d=haversine(lat,lon,t.lat,t.lng);
    const b=bearing(lat,lon,t.lat,t.lng);
    arrow.style.transform=`translateX(-50%) rotate(${(b-heading+360)%360}deg)`;

    rocks.forEach(r=>{
      const rad=Math.min(150,Math.max(30,d));
      r.style.left=180+Math.cos(r.dataset.angle)*rad+"px";
      r.style.top =180+Math.sin(r.dataset.angle)*rad+"px";
    });
  }

  function animateSweep(){
    sweepAngle=(sweepAngle+1.5)%360;
    radarSweep.style.transform=`rotate(${sweepAngle}deg)`;
    if(scannerActive) requestAnimationFrame(animateSweep);
  }

  document.getElementById("start").onclick=async()=>{
    scannerActive=!scannerActive;
    document.getElementById("start").textContent=
      scannerActive?"Deactivate Scanner":"Activate Scanner";
    if(scannerActive){
      spawnRocks();
      animateSweep();
      navigator.geolocation.watchPosition(p=>{
        lat=p.coords.latitude; lon=p.coords.longitude; update();
      },null,{enableHighAccuracy:true});
      if(DeviceOrientationEvent?.requestPermission){
        await DeviceOrientationEvent.requestPermission();
      }
      window.addEventListener("deviceorientation",e=>{
        if(e.alpha!=null) heading=360-e.alpha;
      });
    }
  };
}
</script>
</body>
</html>
