<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Prospecting Scanner – Diagnostic</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #0b0b0b;
    color: #00ffcc;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  h1 { margin: 10px 0; }

  #scanner {
    width: 240px;
    height: 240px;
    border-radius: 50%;
    border: 3px solid #00ffcc;
    position: relative;
    margin: 15px;
  }

  #arrow {
    position: absolute;
    bottom: 50%;
    left: 50%;
    width: 6px;
    height: 100px;
    background: #ff4444;
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(0deg);
    border-radius: 4px;
  }

  #info {
    width: 90%;
    max-width: 360px;
    font-size: 0.95em;
    line-height: 1.4;
    text-align: center;
  }

  .box {
    border: 1px solid #00ffcc44;
    padding: 8px;
    margin: 6px 0;
    border-radius: 6px;
  }

  button {
    margin: 14px;
    padding: 12px 22px;
    font-size: 1em;
    background: #00ffcc;
    color: #000;
    border: none;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Prospecting Scanner</h1>

<div id="scanner">
  <div id="arrow"></div>
</div>

<div id="info">
  <div class="box" id="gps">GPS: —</div>
  <div class="box" id="target">Target: —</div>
  <div class="box" id="distance">Distance: —</div>
  <div class="box" id="bearing">Bearing: —</div>
  <div class="box" id="compass">Compass: —</div>
  <div class="box" id="accuracy">Accuracy: —</div>
</div>

<button id="start">Activate Scanner</button>

<script>
/* ===================== TARGET COORDS ===================== */
/* CHANGE THESE TO TEST */
const TARGET_LAT = -26.640123;
const TARGET_LON = 152.934567;
/* ========================================================= */

let currentLat = null;
let currentLon = null;
let compassHeading = null;
let smoothAngle = 0;

const arrow = document.getElementById("arrow");

/* ------------------ HAVERSINE ------------------ */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ------------------ BEARING ------------------ */
function bearing(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const toDeg = r => (r * 180 / Math.PI + 360) % 360;

  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.cos(toRad(lon2 - lon1));

  return toDeg(Math.atan2(y, x));
}

/* ------------------ GPS ------------------ */
function startGPS() {
  navigator.geolocation.watchPosition(
    pos => {
      currentLat = pos.coords.latitude;
      currentLon = pos.coords.longitude;

      document.getElementById("gps").textContent =
        `You: ${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;

      document.getElementById("accuracy").textContent =
        `Accuracy: ±${pos.coords.accuracy.toFixed(1)} m`;

      update();
    },
    err => alert("GPS error: " + err.message),
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );
}

/* ------------------ COMPASS ------------------ */
function onOrientation(e) {
  let heading = null;

  if (typeof e.webkitCompassHeading === "number") {
    heading = e.webkitCompassHeading; // iOS
  } else if (e.alpha !== null) {
    heading = 360 - e.alpha; // Android
  }

  if (heading === null) return;

  compassHeading = heading;
  update();
}

/* ------------------ UPDATE ------------------ */
function update() {
  if (
    currentLat === null ||
    currentLon === null ||
    compassHeading === null
  ) return;

  const dist = haversine(
    currentLat,
    currentLon,
    TARGET_LAT,
    TARGET_LON
  );

  const bear = bearing(
    currentLat,
    currentLon,
    TARGET_LAT,
    TARGET_LON
  );

  const relative = (bear - compassHeading + 360) % 360;
  smoothAngle += (relative - smoothAngle) * 0.15;

  arrow.style.transform =
    `translateX(-50%) rotate(${smoothAngle}deg)`;

  document.getElementById("target").textContent =
    `Target: ${TARGET_LAT}, ${TARGET_LON}`;

  document.getElementById("distance").textContent =
    dist < 1000
      ? `Distance: ${dist.toFixed(1)} m`
      : `Distance: ${(dist / 1000).toFixed(3)} km`;

  document.getElementById("bearing").textContent =
    `Bearing: ${bear.toFixed(1)}°`;

  document.getElementById("compass").textContent =
    `Compass: ${compassHeading.toFixed(1)}°`;
}

/* ------------------ START ------------------ */
async function start() {
  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    const res = await DeviceOrientationEvent.requestPermission();
    if (res !== "granted") {
      alert("Compass permission denied");
      return;
    }
  }

  window.addEventListener("deviceorientation", onOrientation, true);
  window.addEventListener("deviceorientationabsolute", onOrientation, true);

  startGPS();
}

document.getElementById("start").addEventListener("click", start);
</script>

</body>
</html>
