<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rock Prospecting Scanner</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0b0f14;
  color: #00ffcc;
  text-align: center;
}

h1 { margin-top: 20px; }

button {
  padding: 15px;
  margin: 10px;
  font-size: 18px;
  background: #00ffcc;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

#detector { display: none; }

#hotBar {
  width: 90%;
  height: 40px;
  background: #111;
  margin: 20px auto;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 0 20px #00ffcc;
}

#hotFill {
  height: 100%;
  width: 0%;
  background: linear-gradient(to right, blue, cyan, yellow, orange, red);
  transition: width 0.2s, box-shadow 0.2s;
}

#arrow {
  font-size: 80px;
  margin: 20px;
  transition: transform 0.2s ease;
}

.small {
  font-size: 14px;
  opacity: 0.8;
}
</style>
</head>

<body>

<h1>FIELD PROSPECTING SCANNER</h1>

<div id="locations">
  <p>Select Prospecting Zone</p>
</div>

<div id="detector">
  <div id="arrow">‚¨ÜÔ∏è</div>
  <div id="hotBar"><div id="hotFill"></div></div>
  <p id="status">Initializing‚Ä¶</p>
  <p id="distance"></p>

  <button id="scanRockBtn">SCAN ROCK</button><br>
  <button id="backBtn">CHANGE ZONE</button>
</div>

<script>
// ===============================
// PROSPECTING ZONES
// ===============================
const PROSPECTING_LOCATIONS = [
  { name: "TEST ZONE (HOME)", lat: -26.650000, lng: 152.950000 },
  { name: "FOREST RIDGE", lat: -26.641234, lng: 152.932345 }
];

// ===============================
// ELEMENTS
// ===============================
const locationsDiv = document.getElementById("locations");
const detectorDiv = document.getElementById("detector");
const statusEl = document.getElementById("status");
const distanceEl = document.getElementById("distance");
const hotFill = document.getElementById("hotFill");
const arrow = document.getElementById("arrow");
const scanRockBtn = document.getElementById("scanRockBtn");
const backBtn = document.getElementById("backBtn");

let selectedZone = null;
let currentPosition = null;
let gpsWatchId = null;
let lastVibration = 0;

// ===============================
// BUILD ZONE BUTTONS
// ===============================
PROSPECTING_LOCATIONS.forEach(zone => {
  const btn = document.createElement("button");
  btn.innerText = zone.name;
  btn.onclick = () => selectZone(zone);
  locationsDiv.appendChild(btn);
});

// ===============================
// SELECT ZONE
// ===============================
function selectZone(zone) {
  selectedZone = zone;
  locationsDiv.style.display = "none";
  detectorDiv.style.display = "block";
  statusEl.innerText = "Requesting GPS‚Ä¶";
  startGPS();
}

// ===============================
// START GPS
// ===============================
function startGPS() {
  if (!navigator.geolocation) {
    statusEl.innerText = "GPS not supported on this device";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      positionUpdate(pos);
      gpsWatchId = navigator.geolocation.watchPosition(
        positionUpdate,
        gpsError,
        { enableHighAccuracy: true }
      );
    },
    gpsError,
    { enableHighAccuracy: true }
  );
}

// ===============================
// GPS UPDATE
// ===============================
function positionUpdate(pos) {
  currentPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
  const distance = getDistance(
    currentPosition.lat,
    currentPosition.lng,
    selectedZone.lat,
    selectedZone.lng
  );

  distanceEl.innerText = `Distance: ${Math.round(distance)} m`;
  updateDetector(distance);
}

// ===============================
// HOT / COLD LOGIC WITH VIBRATION & HUM
// ===============================
function updateDetector(distance) {
  const heat = Math.max(0, 100 - distance);
  hotFill.style.width = Math.min(100, heat) + "%";

  // Dramatic glow effect
  hotFill.style.boxShadow = `0 0 ${Math.min(50, heat)}px #ff3300`;

  // Update status text
  if (distance < 10) {
    statusEl.innerText = "üî• STRONG SIGNAL ‚Äî SEARCH AREA";
    heartbeatVibration();
  } else if (distance < 50) {
    statusEl.innerText = "Signal increasing‚Ä¶";
  } else {
    statusEl.innerText = "Scanning‚Ä¶";
  }
}

// heartbeat vibration every 1s if very hot
function heartbeatVibration() {
  const now = Date.now();
  if (now - lastVibration > 1000) {
    lastVibration = now;
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]); // pulse pattern
    playHum();
  }
}

// Play a subtle hum
function playHum() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioCtx.createOscillator();
  oscillator.type = "sine";
  oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
  const gainNode = audioCtx.createGain();
  gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime); // very low volume
  oscillator.connect(gainNode).connect(audioCtx.destination);
  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.2); // short hum
}

// ===============================
// DISTANCE (HAVERSINE)
// ===============================
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const œÜ1 = lat1 * Math.PI/180;
  const œÜ2 = lat2 * Math.PI/180;
  const ŒîœÜ = (lat2-lat1) * Math.PI/180;
  const ŒîŒª = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// ===============================
// COMPASS
// ===============================
window.addEventListener("deviceorientation", e => {
  if (!currentPosition || e.alpha === null) return;
  const heading = e.alpha;
  const bearing = calculateBearing(
    currentPosition.lat,
    currentPosition.lng,
    selectedZone.lat,
    selectedZone.lng
  );
  arrow.style.transform = `rotate(${bearing - heading}deg)`;
});

function calculateBearing(lat1, lon1, lat2, lon2) {
  const y = Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180);
  const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
            Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI + 360) % 360;
}

// ===============================
// GPS ERRORS
// ===============================
function gpsError(err) {
  if (err.code === 1) statusEl.innerText = "Location access denied. Enable GPS permissions and reload.";
  else statusEl.innerText = "GPS error: " + err.message;
}

// ===============================
// SCAN ROCK
// ===============================
scanRockBtn.onclick = () => {
  window.location.href = "https://challengeaccepted.quest/scan-rock";
};

// ===============================
// BACK
// ===============================
backBtn.onclick = () => {
  detectorDiv.style.display = "none";
  locationsDiv.style.display = "block";
};
</script>

</body>
</html>
