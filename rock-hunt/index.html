<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #0a0a0a;
    color: #00ffcc;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  h1 { margin: 0.2em 0; }

  #scanner {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    border: 3px solid #00ffcc;
    position: relative;
    margin: 20px;
  }

  #arrow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 6px;
    height: 90px;
    background: #ff4444;
    transform-origin: bottom center;
    transform: translate(-50%, -100%) rotate(0deg);
    border-radius: 3px;
  }

  #info {
    text-align: center;
    font-size: 1.1em;
  }

  button {
    margin-top: 20px;
    padding: 12px 20px;
    font-size: 1em;
    background: #00ffcc;
    border: none;
    border-radius: 8px;
    color: #000;
  }
</style>
</head>
<body>

<h1>Prospecting Scanner</h1>

<div id="scanner">
  <div id="arrow"></div>
</div>

<div id="info">
  <div id="distance">Distance: —</div>
  <div id="coords"></div>
  <div id="target"></div>
</div>
<button id="start">Activate Scanner</button>

<script>
/* ================= CONFIG ================= */
const TARGET_LAT = -26.640123;   // <-- set your target
const TARGET_LON = 152.934567;
/* ========================================== */

let currentLat = null;
let currentLon = null;
let compassHeading = null;
let smoothedAngle = 0;

const arrow = document.getElementById("arrow");
const distanceEl = document.getElementById("distance");
const headingEl = document.getElementById("heading");

/* ---------- GEOLOCATION ---------- */
function startGPS() {
  navigator.geolocation.watchPosition(
    pos => {
      currentLat = pos.coords.latitude;
      currentLon = pos.coords.longitude;
      updateUI();
    },
    err => alert("GPS error: " + err.message),
    {
      enableHighAccuracy: true,
      maximumAge: 500,
      timeout: 10000
    }
  );
}

/* ---------- DISTANCE (HAVERSINE) ---------- */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ---------- BEARING ---------- */
function bearing(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const toDeg = r => (r * 180 / Math.PI + 360) % 360;

  const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.cos(toRad(lon2 - lon1));

  return toDeg(Math.atan2(y, x));
}

/* ---------- COMPASS ---------- */
function handleOrientation(e) {
  let heading;

  if (typeof e.webkitCompassHeading === "number") {
    heading = e.webkitCompassHeading; // iOS
  } else if (e.absolute && e.alpha !== null) {
    heading = 360 - e.alpha; // Android
  } else {
    return;
  }

  compassHeading = heading;
  updateUI();
}

/* ---------- UI UPDATE ---------- */
function updateUI() {
  if (
    currentLat === null ||
    currentLon === null ||
    compassHeading === null
  ) return;

  const dist = haversine(currentLat, currentLon, TARGET_LAT, TARGET_LON);
  const bear = bearing(currentLat, currentLon, TARGET_LAT, TARGET_LON);

  const targetAngle = (bear - compassHeading + 360) % 360;

  // smoothing
  smoothedAngle += (targetAngle - smoothedAngle) * 0.15;

  arrow.style.transform =
    `translate(-50%, -100%) rotate(${smoothedAngle}deg)`;

  distanceEl.textContent =
    dist < 1000
      ? `Distance: ${dist.toFixed(1)} m`
      : `Distance: ${(dist / 1000).toFixed(2)} km`;

  headingEl.textContent =
    `Bearing: ${bear.toFixed(0)}° | Compass: ${compassHeading.toFixed(0)}°`;
}

/* ---------- PERMISSIONS ---------- */
async function startScanner() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    const res = await DeviceOrientationEvent.requestPermission();
    if (res !== "granted") {
      alert("Compass permission denied");
      return;
    }
  }

  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);

  startGPS();
}

document.getElementById("start").addEventListener("click", startScanner);
</script>

</body>
</html>
