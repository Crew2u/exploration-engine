<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Futuristic Prospecting Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { 
  margin:0; font-family:system-ui,sans-serif; background:#000; color:#0f0;
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:10px;
}
h1 { 
  margin:10px 0; text-align:center; text-shadow:0 0 10px #0f0,0 0 20px #0f0555; 
}

#deviceFrame { 
  width:400px; height:400px; border:10px solid #00ff44; border-radius:30px;
  box-shadow:0 0 50px #00ff44 inset; display:flex; align-items:center; justify-content:center; position:relative;
  background:#001100; transition: box-shadow 0.2s ease, border-color 0.2s ease;
}

#scanner-container { 
  width:360px; height:360px; border-radius:50%; position:relative; overflow:hidden;
  background:radial-gradient(circle at center, #001100 0%, #002200 80%);
  box-shadow: inset 0 0 30px #00ff0044, 0 0 40px #00ff0088; border:3px solid #00ff00;
}

#radarSweep { 
  position:absolute; width:100%; height:100%; border-radius:50%;
  background:conic-gradient(rgba(0,255,0,0.25) 0deg, rgba(0,255,0,0) 25deg, rgba(0,255,0,0) 360deg);
  pointer-events:none; transform:rotate(0deg); z-index:2; filter:blur(2px); 
}

#radarSweep::after {
  content:''; position:absolute; width:100%; height:100%; border-radius:50%;
  background:conic-gradient(rgba(0,255,0,0.1) 0deg, rgba(0,255,0,0) 360deg);
  filter:blur(6px); z-index:-1; top:0; left:0;
}

#radarArc { 
  position:absolute; width:100%; height:100%; border-radius:50%;
  box-shadow:0 0 20px #00ff44 inset, 0 0 30px #00ff4488 inset; z-index:3; pointer-events:none; 
}

#radarRings { 
  position:absolute; width:100%; height:100%; border-radius:50%; z-index:1; pointer-events:none; 
}

.ring { 
  position:absolute; border:1px solid #00ff22; border-radius:50%;
  top:50%; left:50%; transform:translate(-50%,-50%) scale(0); opacity:0.2;
  animation:ringPulse 4s infinite; 
}

@keyframes ringPulse {
  0% { transform:translate(-50%,-50%) scale(0); opacity:0.1; }
  50% { transform:translate(-50%,-50%) scale(1); opacity:0.3; }
  100% { transform:translate(-50%,-50%) scale(0); opacity:0.1; }
}

#arrow { 
  position:absolute; bottom:50%; left:50%; width:6px; height:120px; background:#ff4444;
  transform-origin:bottom center; border-radius:4px; transition:transform 0.05s ease-out; z-index:5;
  box-shadow:0 0 8px #ff4444,0 0 20px #ff4444AA; 
}

.rock { 
  position:absolute; border-radius:50%; box-shadow:0 0 8px #ffff00,0 0 16px #ffff0055;
  cursor:pointer; z-index:7; animation:rockPulse 1s infinite alternate; 
}

@keyframes rockPulse { 0% { transform:scale(1); } 100% { transform:scale(1.4); } }

#qrVideo { display:none; position:absolute; width:360px; height:360px; top:0; left:0; border-radius:50%; object-fit:cover; z-index:0; }
#qrOverlay { position:absolute; width:360px; height:360px; top:0; left:0; border-radius:50%; pointer-events:none; z-index:6; box-shadow:0 0 30px #0f0 inset; }
#qrOverlay:before { content:"PLACE ROCK CODE HERE"; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#0f0; font-size:1.2em; text-shadow:0 0 8px #0f0,0 0 16px #0f0444; }

#overlayPulse { 
  position:absolute; width:360px; height:360px; border-radius:50%; top:0; left:0;
  box-shadow:0 0 40px #00ff44 inset, 0 0 60px #00ff4488 inset; pointer-events:none; z-index:1;
  animation:scannerPulse 2s infinite alternate; 
}

@keyframes scannerPulse { 0% { transform:scale(0.98); opacity:0.7; } 100% { transform:scale(1); opacity:1; } }

#info { width:90%; max-width:360px; font-size:0.9em; line-height:1.4; text-align:center; margin-top:10px; }
.box { border:1px solid #00ff0044; padding:6px; margin:4px 0; border-radius:6px; background:#00110099; }

button, select { margin:10px 0; padding:12px 22px; font-size:1em; border-radius:8px; border:none; background:#00ff00; color:#000; cursor:pointer; }
#scanRock { background:#ff4444; color:#fff; font-weight:bold; width:90%; max-width:360px; box-shadow:0 0 8px #ff4444; }
#proximityMeter { width:90%; max-width:360px; height:20px; background:#004422; border:1px solid #00ff44; border-radius:10px; overflow:hidden; margin-top:6px; }
#proximityFill { width:0%; height:100%; background:#ff4444; transition:width 0.2s ease; }
</style>
</head>
<body>
<h1>Futuristic Prospecting Scanner</h1>
<select id="locationSelect"><option>Loading locations...</option></select>
<div id="deviceFrame">
  <div id="scanner-container">
    <video id="qrVideo" autoplay playsinline></video>
    <div id="overlayPulse"></div>
    <div id="radarSweep"></div>
    <div id="radarArc"></div>
    <div id="radarRings"></div>
    <div id="arrow"></div>
    <div id="qrOverlay"></div>
  </div>
</div>

<div id="info">
  <div class="box" id="gps">GPS: â€”</div>
  <div class="box" id="target">Target: â€”</div>
  <div class="box" id="distance">Distance: â€”</div>
  <div class="box" id="bearing">Bearing: â€”</div>
  <div class="box" id="compass">Compass: â€”</div>
  <div class="box" id="accuracy">Accuracy: â€”</div>
  <div class="box" id="hotcold">Proximity: â€”</div>
</div>

<div id="proximityMeter"><div id="proximityFill"></div></div>

<button id="start">Activate Scanner</button>
<button id="scanRock">Start QR Scanner</button>
<button id="toggleCamera">Toggle Camera</button>

<script src="locations.js?v=12"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
function initScanner(){
  if(!Array.isArray(PROSPECTING_LOCATIONS)||PROSPECTING_LOCATIONS.length===0){ alert("No PROSPECTING_LOCATIONS!"); return;}
  
  let TARGET_INDEX=0, currentLat=null, currentLon=null, compassHeading=null, smoothAngle=0, sweepAngle=0;
  let rocks=[], cameraStream=null, qrActive=false;
  
  const arrow=document.getElementById("arrow");
  const select=document.getElementById("locationSelect");
  const proximityFill=document.getElementById("proximityFill");
  const scanRockBtn=document.getElementById("scanRock");
  const toggleCamBtn=document.getElementById("toggleCamera");
  const scannerDiv=document.getElementById("scanner-container");
  const radarSweep=document.getElementById("radarSweep");
  const radarArc=document.getElementById("radarArc");
  const radarRings=document.getElementById("radarRings");
  const qrVideo=document.getElementById("qrVideo");
  const deviceFrame=document.getElementById("deviceFrame");

  function getTarget(){ return PROSPECTING_LOCATIONS[TARGET_INDEX]; }
  function toRad(d){return d*Math.PI/180;}
  function toDeg(r){return (r*180/Math.PI+360)%360;}
  function haversine(lat1,lon1,lat2,lon2){const R=6371000,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
  function bearing(lat1,lon1,lat2,lon2){const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2)), x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1)); return toDeg(Math.atan2(y,x));}

  select.innerHTML=""; PROSPECTING_LOCATIONS.forEach((loc,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=loc.name; select.appendChild(opt);});
  select.value=0;

  select.addEventListener('change',()=>{
    TARGET_INDEX=parseInt(select.value);
    spawnRocks();
    update();
  });

  function spawnRocks(){
    rocks.forEach(r=>r.remove()); rocks.length=0;
    for(let i=0;i<8;i++){
      const rock=document.createElement('div'); rock.className='rock';
      rock.dataset.rockId=['G','S','C','M'][Math.floor(Math.random()*4)]+Math.floor(Math.random()*1000);
      rock.style.background=['#ffcc00','#cccccc','#44ccff','#ff44ff'][Math.floor(Math.random()*4)];
      rock.style.width='20px'; rock.style.height='20px';
      rock.dataset.angle=Math.random()*2*Math.PI;  
      rock.dataset.radius=Math.random()*50+10;     
      scannerDiv.appendChild(rock); rocks.push(rock);
    }
  }

  function updateRocks(distToTarget){
    const target=getTarget();
    rocks.forEach(rock=>{
      // Gradual appearance
      let alpha=Math.max(0, Math.min(1, 1-(distToTarget/100)));
      rock.style.display=alpha>0.05?'block':'none';
      rock.style.opacity=alpha;

      if(alpha<=0) return;
      const baseRadius=parseFloat(rock.dataset.radius);
      const radius=Math.max(2, baseRadius*(distToTarget/50)); 
      const angle=parseFloat(rock.dataset.angle);
      const x=180 + Math.cos(angle-(compassHeading||0)*Math.PI/180)*radius - parseFloat(rock.style.width)/2;
      const y=180 + Math.sin(angle-(compassHeading||0)*Math.PI/180)*radius - parseFloat(rock.style.height)/2;
      rock.style.left=x+'px'; rock.style.top=y+'px';
      rock.style.width=rock.style.height=(10 + (5/distToTarget*50))+'px';
    });
  }

  function update(){
    const target=getTarget();  
    if(currentLat===null||currentLon===null||compassHeading===null) return;
    const dist=haversine(currentLat,currentLon,target.lat,target.lng);
    const bear=bearing(currentLat,currentLon,target.lat,target.lng);
    const relative=(bear-compassHeading+360)%360;
    smoothAngle+=(relative-smoothAngle)*0.12; // smoother
    arrow.style.transform=`translateX(-50%) rotate(${smoothAngle}deg)`;

    document.getElementById("target").textContent=`Target: ${target.name} (${target.lat.toFixed(6)}, ${target.lng.toFixed(6)})`;
    document.getElementById("distance").textContent=dist<1000?`Distance: ${dist.toFixed(1)} m`:`Distance: ${(dist/1000).toFixed(3)} km`;
    document.getElementById("bearing").textContent=`Bearing: ${bear.toFixed(1)}Â°`;
    document.getElementById("compass").textContent=`Compass: ${compassHeading.toFixed(1)}Â°`;

    let hotcold='', colorShift='#00ff44';
    if(dist<=5){ hotcold='ðŸ”¥ Very Hot'; colorShift='#ff4444'; triggerVibration();}
    else if(dist<=20) hotcold='ðŸŒ¡ï¸ Hot', colorShift='#ff8800';
    else if(dist<=50) hotcold='ðŸŒ¡ï¸ Warm', colorShift='#ffff00';
    else if(dist<=100) hotcold='â„ï¸ Cold', colorShift='#00aaff';
    else hotcold='ðŸ¥¶ Very Cold', colorShift='#0044ff';
    document.getElementById("hotcold").textContent=`Proximity: ${hotcold}`;

    // Proximity effects
    deviceFrame.style.boxShadow=`0 0 ${10+(50/dist)}px ${colorShift} inset, 0 0 ${20+(100/dist)}px ${colorShift}88 inset`;
    deviceFrame.style.borderColor=colorShift;

    const pct=Math.min(1,200/dist);
    proximityFill.style.width=`${(pct*100).toFixed(1)}%`;
    radarArc.style.boxShadow=`0 0 ${10+(50/dist)}px ${colorShift} inset, 0 0 ${20+(100/dist)}px ${colorShift}88 inset`;

    updateRocks(dist);
  }

  function animateSweep(){ 
    sweepAngle=(sweepAngle+2)%360; 
    radarSweep.style.transform=`rotate(${sweepAngle}deg)`; 
    requestAnimationFrame(animateSweep); 
  }

  function createRings(){
    for(let i=1;i<=3;i++){
      const r=document.createElement('div'); r.className='ring';
      r.style.width=(i*100)+'px'; r.style.height=(i*100)+'px';
      r.style.animationDelay=(i*0.8)+'s'; radarRings.appendChild(r);
    }
  }

  function triggerVibration(){ if(navigator.vibrate && Math.random()<0.3) navigator.vibrate(150); }

  function startGPS(){
    if(!navigator.geolocation){alert("Geolocation unsupported");return;}
    navigator.geolocation.watchPosition(pos=>{
      currentLat=pos.coords.latitude; currentLon=pos.coords.longitude;
      document.getElementById("gps").textContent=`You: ${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
      document.getElementById("accuracy").textContent=`Accuracy: Â±${pos.coords.accuracy.toFixed(1)} m`;
      update();
    },err=>alert("GPS error:"+err.message),{enableHighAccuracy:true,maximumAge:0,timeout:10000});
  }

  async function start(){
    createRings(); spawnRocks(); animateSweep();

    // Device orientation permission handling
    if(typeof DeviceOrientationEvent!=="undefined"){
      if(typeof DeviceOrientationEvent.requestPermission==="function"){
        const res=await DeviceOrientationEvent.requestPermission();
        if(res!=="granted"){ alert("Compass permission denied"); return; }
      }
      window.addEventListener("deviceorientation",e=>{
        if(e.alpha!==null){ compassHeading=360-e.alpha; update();}
      },true);
    } else {
      alert("Device orientation not supported. Compass will be inactive.");
    }

    startGPS();
  }

  async function startQRScanner(){
    if(qrActive) return; qrActive=true; qrVideo.style.display='block';
    try{
      cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      qrVideo.srcObject=cameraStream;
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
      function scanFrame(){
        if(!qrActive) return;
        if(qrVideo.readyState===qrVideo.HAVE_ENOUGH_DATA){
          canvas.width=qrVideo.videoWidth; canvas.height=qrVideo.videoHeight;
          ctx.drawImage(qrVideo,0,0,canvas.width,canvas.height);
          const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
          const code=jsQR(imageData.data,canvas.width,canvas.height);
          if(code && code.data){
            qrVideo.srcObject.getTracks().forEach(t=>t.stop());
            window.location.href=`https://www.challengeaccepted.quest/prospect-scan?rock=${code.data}`;
            return;
          }
        }
        requestAnimationFrame(scanFrame);
      }
      requestAnimationFrame(scanFrame);
    }catch(e){ alert("Camera QR scanning failed: "+e.message); qrActive=false;}
  }

  function toggleCamera(){
    if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); qrVideo.style.display='none'; cameraStream=null; qrActive=false;}
    else startQRScanner();
  }

  document.getElementById("start").addEventListener("click",start);
  scanRockBtn.addEventListener("click",startQRScanner);
  toggleCamBtn.addEventListener("click",toggleCamera);
}

setTimeout(initScanner,50);
</script>
</body>
</html>
